@page "/mobile-app-report"
@rendermode InteractiveServer
@using ReportBuilder.Models
@using ReportBuilder.Services
@inject IJSRuntime JSRuntime
@inject ToastService ToastService
@inject LocalStorageService LocalStorage

<PageTitle>Mobile App Store Performance Report</PageTitle>

<!-- Hidden File Inputs -->
<InputFile id="pdfFileInput" OnChange="HandlePdfImport" accept=".pdf" style="display: none;" />

<!-- Floating Action Button Menu -->
<div class="fab-container">
    @if (isFabMenuOpen)
    {
        <div class="fab-backdrop" @onclick="ToggleFabMenu"></div>
    }

    <div class="fab-menu @(isFabMenuOpen ? "open" : "")">
        <FABMenuItem CssClass="fab-menu-import-pdf" OnClick="@TriggerPdfUpload" IsDisabled="@isImporting" Title="Import PDF">
            @if (isImporting)
            {
                <span class="fab-icon spinner-border spinner-border-sm"></span>
                <span class="fab-label">Importing...</span>
            }
            else
            {
                <span class="fab-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                        <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                        <path d="M8 14h8v2H8v-2zm0-3h8v2H8v-2z"/>
                    </svg>
                </span>
                <span class="fab-label">Import PDF</span>
            }
        </FABMenuItem>

        <FABMenuItem Icon="✕" Label="Clear Form" Title="Clear Form" CssClass="fab-menu-clear" OnClick="@ClearForm" />
    </div>

    <button type="button" class="fab-button @(isFabMenuOpen ? "open" : "")" @onclick="ToggleFabMenu">
        @if (isFabMenuOpen)
        {
            <span class="fab-button-icon-close">×</span>
        }
        else
        {
            <span class="fab-button-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="28" height="28">
                    <path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/>
                </svg>
            </span>
        }
    </button>
</div>

<div style="max-width: 1600px; margin: 0 auto;">
    <div style="margin-bottom: 1.25rem;">
        <h1 style="margin-bottom: 0.375rem;">Mobile App Store Performance Report</h1>
        <p style="color: var(--text-secondary); font-size: 0.9375rem; margin-bottom: 0;">Generate comprehensive PDF reports with customizable metrics and comparisons</p>
    </div>

    <ImportDialog
        IsVisible="@showImportDialog"
        OnImportToPrevious="@ImportToPreviousPeriod"
        OnImportToCurrent="@ImportToCurrentPeriod"
        OnCancel="@CancelImport" />

    <EditForm Model="@config" OnValidSubmit="GenerateReport">
        <div class="row">
            <div class="col-md-12">
                <!-- General Information Section -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">General Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-inputs-bottom">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Company Name</label>
                                    <InputText @bind-Value="config.CompanyName" class="form-control" placeholder="e.g., My Company" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Report Month</label>
                                    <InputNumber TValue="int?" @bind-Value="config.ReportMonth" class="form-control" placeholder="@DateTime.Now.Month.ToString()" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Report Day</label>
                                    <InputNumber TValue="int?" @bind-Value="config.ReportDay" class="form-control" placeholder="@DateTime.Now.Day.ToString()" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Report Year</label>
                                    <InputNumber TValue="int?" @bind-Value="config.ReportYear" class="form-control" placeholder="@DateTime.Now.Year.ToString()" />
                                </div>
                            </div>
                        </div>
                        <div class="row align-inputs-bottom">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Created By Name</label>
                                    <InputText @bind-Value="config.CreatedByName" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Created By Title</label>
                                    <InputText @bind-Value="config.CreatedByTitle" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">
                                        iOS App ID
                                        <span style="font-size: 0.85em; color: var(--text-secondary);">(opens metrics)</span>
                                    </label>
                                    <div class="input-group">
                                        <InputText @bind-Value="iosAppIdentifier" @bind-Value:after="OnIOSAppIdentifierChanged" class="form-control" placeholder="e.g., 123456789" />
                                        @if (!string.IsNullOrWhiteSpace(iosAppIdentifier))
                                        {
                                            <button type="button" class="btn btn-outline-secondary" @onclick="ClearIOSAppIdentifier" title="Clear iOS App ID">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                                                </svg>
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Android App ID
                                        <span style="font-size: 0.85em; color: var(--text-secondary);">(opens metrics)</span>
                                    </label>
                                    <div class="input-group">
                                        <InputText @bind-Value="androidAppIdentifier" @bind-Value:after="OnAndroidAppIdentifierChanged" class="form-control" placeholder="e.g., com.example.app" />
                                        @if (!string.IsNullOrWhiteSpace(androidAppIdentifier))
                                        {
                                            <button type="button" class="btn btn-outline-secondary" @onclick="ClearAndroidAppIdentifier" title="Clear Android App ID">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                                                </svg>
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check mb-3">
                                    <InputCheckbox @bind-Value="config.IncludeLastPeriodData" class="form-check-input" id="includeLastPeriod" />
                                    <label class="form-check-label" for="includeLastPeriod">
                                        <strong>Include Last Period Data & Comparisons</strong> (enables comparison fields and % change calculations across all sections)
                                    </label>
                                </div>
                            </div>
                        </div>
                        @if (config.IncludeLastPeriodData)
                        {
                            <div class="row align-inputs-bottom">
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label class="form-label">Last Report Month</label>
                                        <InputNumber TValue="int?" @bind-Value="config.LastReportMonth" class="form-control" placeholder="9" />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label class="form-label">Last Report Day</label>
                                        <InputNumber TValue="int?" @bind-Value="config.LastReportDay" class="form-control" placeholder="22" />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label class="form-label">Last Report Year</label>
                                        <InputNumber TValue="int?" @bind-Value="config.LastReportYear" class="form-control" placeholder="2025" />
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Section Toggles -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Report Sections</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <InputCheckbox @bind-Value="config.IncludeExecutiveSummary" class="form-check-input" id="execSummary" />
                                    <label class="form-check-label" for="execSummary">
                                        Include Executive Summary
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <InputCheckbox @bind-Value="config.IncludeIOSSection" @bind-Value:after="OnIOSSectionChanged" class="form-check-input" id="iosSection" />
                                    <label class="form-check-label" for="iosSection">
                                        Include iOS Platform Performance
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <InputCheckbox @bind-Value="config.IncludeAndroidSection" @bind-Value:after="OnAndroidSectionChanged" class="form-check-input" id="androidSection" />
                                    <label class="form-check-label" for="androidSection">
                                        Include Android Platform Performance
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <InputCheckbox @bind-Value="config.IncludePlatformComparison" class="form-check-input" id="platformComp" disabled="@(!config.IncludeIOSSection || !config.IncludeAndroidSection)" />
                                    <label class="form-check-label" for="platformComp" style="@(!config.IncludeIOSSection || !config.IncludeAndroidSection ? "opacity: 0.5;" : "")">
                                        Include Platform Comparison
                                    </label>
                                    @if (!config.IncludeIOSSection || !config.IncludeAndroidSection)
                                    {
                                        <small class="form-text" style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                            Requires both iOS and Android sections
                                        </small>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <InputCheckbox @bind-Value="config.IncludeHighVarianceMetrics" class="form-check-input" id="highVariance" disabled="@(!config.IncludeLastPeriodData)" />
                                    <label class="form-check-label" for="highVariance" style="@(!config.IncludeLastPeriodData ? "opacity: 0.5;" : "")">
                                        Include High Variance Metrics
                                    </label>
                                    @if (!config.IncludeLastPeriodData)
                                    {
                                        <small class="form-text" style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                            Requires Last Period Data enabled
                                        </small>
                                    }
                                </div>
                            </div>
                        </div>
                        @if (config.IncludeHighVarianceMetrics && config.IncludeLastPeriodData)
                        {
                            <div class="row align-items-center mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">High Variance Threshold (%)</label>
                                    <InputNumber TValue="double" @bind-Value="config.HighVarianceThreshold" class="form-control" min="1" max="500" step="0.1" />
                                    <small class="form-text" style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                        Metrics with changes over ±@(config.HighVarianceThreshold)% will be included in the report
                                    </small>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Executive Summary Section -->
                @if (config.IncludeExecutiveSummary)
                {
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Executive Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Summary Text</label>
                                <InputTextArea @bind-Value="config.ExecutiveSummary" class="form-control" rows="6" placeholder="Enter your executive summary here..."></InputTextArea>
                                <small class="form-text text-muted">Provide a brief overview of the key metrics and trends for this reporting period.</small>
                            </div>
                        </div>
                    </div>
                }

                <!-- iOS Metrics Section -->
                @if (config.IncludeIOSSection)
                {
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">iOS Platform Metrics</h5>
                        </div>
                        <div class="card-body">
                            <h6>Current Period</h6>
                            <div class="row align-inputs-bottom">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Total Downloads</label>
                                        <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.TotalDownloads" @bind-Value:after="OnDownloadSourceChanged" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Daily Downloads</label>
                                        <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.DailyDownloads" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Total Crashes</label>
                                        <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.TotalCrashes" class="form-control" />
                                    </div>
                                </div>
                            </div>
                            <div class="row align-inputs-bottom">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Daily Active Users (30-Day Avg)</label>
                                        <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.DevicesActiveWithin30Days" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Lifetime Deletions</label>
                                        <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.LifetimeDeletions" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Lifetime Re-Downloads</label>
                                        <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.LifetimeReDownloads" class="form-control" />
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                    <label class="form-label fw-bold">Version Breakdown (Optional)</label>
                                    <p class="text-muted small mb-2">Break down Daily Active Users by individual app versions</p>
                                    
                                    @if (HasDailyActiveUsersMismatch())
                                    {
                                        <div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
                                            <svg class="warning-icon me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M12 2L1 21h22L12 2zm0 3.5L19.5 19h-15L12 5.5zM11 10v4h2v-4h-2zm0 5v2h2v-2h-2z"/>
                                            </svg>
                                            <div>
                                                <strong>Warning:</strong> Version breakdown total (@GetDailyActiveUsersBreakdownTotal().ToString("N0")) doesn't match Devices Active within Past 30 Days (@(config.IOSMetrics.DevicesActiveWithin30Days?.ToString("N0") ?? "0"))
                                            </div>
                                        </div>
                                    }
                                    
                                    @foreach (var version in config.IOSMetrics.DailyActiveUsersByVersionBreakdown)
                                    {
                                        <div class="row align-items-end mb-2">
                                            <div class="col-md-3">
                                                <label class="form-label small">Version Number</label>
                                                <InputText @bind-Value="version.VersionNumber" class="form-control form-control-sm" placeholder="e.g., 2.1.0" />
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">Daily Active Users (30-Day Avg)</label>
                                                <InputNumber TValue="double?" @bind-Value="version.DailyActiveUsers" class="form-control form-control-sm" />
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-sm btn-danger" @onclick="() => RemoveIOSVersionBreakdown(version)">Remove</button>
                                            </div>
                                        </div>
                                    }
                                    
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" @onclick="AddIOSVersionBreakdown">
                                        + Add Version
                                    </button>
                                </div>

                            @if (config.IncludeLastPeriodData)
                            {
                                <h6 class="mt-4">Last Period (Optional - for comparison)</h6>
                                <div class="row align-inputs-bottom">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Total Downloads (Last)</label>
                                            <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.TotalDownloadsLast" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Daily Downloads (Last)</label>
                                            <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.DailyDownloadsLast" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Total Crashes (Last)</label>
                                            <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.TotalCrashesLast" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row align-inputs-bottom">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Daily Active Users (30-Day Avg) (Last)</label>
                                            <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.DevicesActiveWithin30DaysLast" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Lifetime Deletions (Last)</label>
                                            <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.LifetimeDeletionsLast" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Lifetime Re-Downloads (Last)</label>
                                            <InputNumber TValue="double?" @bind-Value="config.IOSMetrics.LifetimeReDownloadsLast" class="form-control" />
                                        </div>
                                    </div>
                                </div>



                            }

                            <h6 class="mt-4">Download Sources</h6>
                            @if (HasDownloadSourceMismatch())
                            {
                                <div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
                                    <svg class="warning-icon me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2L1 21h22L12 2zm0 3.5L19.5 19h-15L12 5.5zM11 10v4h2v-4h-2zm0 5v2h2v-2h-2z"/>
                                    </svg>
                                    <div>
                                        <strong>Warning:</strong> Download Sources total (@(GetDownloadSourcesTotal().ToString("N0"))) does not match Total Downloads (@((config.IOSMetrics.TotalDownloads ?? 0).ToString("N0")))
                                    </div>
                                </div>
                            }
                            <div class="form-check mb-3">
                                <InputCheckbox @bind-Value="config.ShowPercentBySource" class="form-check-input" id="showPercentBySource" />
                                <label class="form-check-label" for="showPercentBySource">
                                    Show Percent by Source in Report
                                </label>
                            </div>
                            <div class="row">
                            @for (int i = 0; i < config.IOSMetrics.DownloadSources.Count; i++)
                            {
                                var index = i;
                                <DownloadSourceCard
                                    Source="@config.IOSMetrics.DownloadSources[index]"
                                    IncludeLastPeriod="@config.IncludeLastPeriodData"
                                    OnRemove="@(() => RemoveDownloadSource(index))"
                                    OnValueChanged="@OnDownloadSourceChanged" />
                            }
                            </div>
                            <button type="button" class="btn btn-success mt-2" @onclick="AddDownloadSource">Add Download Source</button>
                        </div>
                    </div>
                }

                <!-- Android Metrics Section -->
                @if (config.IncludeAndroidSection)
                {
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Android Platform Metrics</h5>
                        </div>
                        <div class="card-body">
                            <h6>Current Period</h6>
                            <div class="row align-inputs-bottom">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Total Downloads</label>
                                        <InputNumber TValue="double?" @bind-Value="config.AndroidMetrics.TotalDownloads" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Daily Downloads</label>
                                        <InputNumber TValue="double?" @bind-Value="config.AndroidMetrics.DailyDownloads" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Total Crashes</label>
                                        <InputNumber TValue="double?" @bind-Value="config.AndroidMetrics.TotalCrashes" class="form-control" />
                                    </div>
                                </div>
                            </div>

                            @if (config.IncludeLastPeriodData)
                            {
                                <h6 class="mt-4">Last Period (Optional - for comparison)</h6>
                                <div class="row align-inputs-bottom">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Total Downloads (Last)</label>
                                            <InputNumber TValue="double?" @bind-Value="config.AndroidMetrics.TotalDownloadsLast" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Daily Downloads (Last)</label>
                                            <InputNumber TValue="double?" @bind-Value="config.AndroidMetrics.DailyDownloadsLast" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Total Crashes (Last)</label>
                                            <InputNumber TValue="double?" @bind-Value="config.AndroidMetrics.TotalCrashesLast" class="form-control" />
                                        </div>
                                    </div>
                                </div>

                            }
                        </div>
                    </div>
                }


                <!-- Generate Button -->
                <div style="text-align: center; margin: 2rem 0 1.5rem 0;">
                    <button type="submit" class="btn btn-primary btn-lg" disabled="@isGenerating">
                        @if (isGenerating)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Generating PDF...</span>
                        }
                        else
                        {
                            <span>Generate PDF Report</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </EditForm>
</div>

@code {
    private MobileAppReportConfig config = new();
    private bool isGenerating = false;
    private bool isImporting = false;
    private bool showImportDialog = false;
    private MobileAppReportConfig? pendingImportConfig = null;
    private bool isFabMenuOpen = false;
    private string iosAppIdentifier = string.Empty;
    private string androidAppIdentifier = string.Empty;

    private void ToggleFabMenu()
    {
        isFabMenuOpen = !isFabMenuOpen;
    }

    private void ClearForm()
    {
        config = new MobileAppReportConfig();

        // Re-initialize with default download sources
        config.IOSMetrics.DownloadSources = new List<DownloadSource>
        {
            new() { Name = "App Store Search" },
            new() { Name = "Web Referrer" },
            new() { Name = "App Referrer" },
            new() { Name = "App Store Browse" },
            new() { Name = "Unavailable" }
        };

        isFabMenuOpen = false;
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        // Initialize with default download sources
        config.IOSMetrics.DownloadSources = new List<DownloadSource>
        {
            new() { Name = "App Store Search" },
            new() { Name = "Web Referrer" },
            new() { Name = "App Referrer" },
            new() { Name = "App Store Browse" },
            new() { Name = "Unavailable" }
        };

        // Load cached app identifiers
        iosAppIdentifier = await LocalStorage.GetIOSAppIdentifierAsync() ?? string.Empty;
        androidAppIdentifier = await LocalStorage.GetAndroidAppIdentifierAsync() ?? string.Empty;

        // No default for report dates - user should fill in or import
    }

    private async Task OnIOSAppIdentifierChanged()
    {
        if (!string.IsNullOrWhiteSpace(iosAppIdentifier))
        {
            await LocalStorage.SaveIOSAppIdentifierAsync(iosAppIdentifier);
        }
    }

    private async Task OnAndroidAppIdentifierChanged()
    {
        if (!string.IsNullOrWhiteSpace(androidAppIdentifier))
        {
            await LocalStorage.SaveAndroidAppIdentifierAsync(androidAppIdentifier);
        }
    }

    private async Task ClearIOSAppIdentifier()
    {
        iosAppIdentifier = string.Empty;
        await LocalStorage.ClearIOSAppIdentifierAsync();
    }

    private async Task ClearAndroidAppIdentifier()
    {
        androidAppIdentifier = string.Empty;
        await LocalStorage.ClearAndroidAppIdentifierAsync();
    }

    private void TriggerPdfUpload()
    {
        isFabMenuOpen = false;
        JSRuntime.InvokeVoidAsync("triggerFileUpload", "pdfFileInput");
    }

    private void OnIOSSectionChanged()
    {
        // Auto-uncheck Platform Comparison if iOS is unchecked and it was previously checked
        if (!config.IncludeIOSSection && config.IncludePlatformComparison)
        {
            config.IncludePlatformComparison = false;
        }
    }

    private void OnAndroidSectionChanged()
    {
        // Auto-uncheck Platform Comparison if Android is unchecked and it was previously checked
        if (!config.IncludeAndroidSection && config.IncludePlatformComparison)
        {
            config.IncludePlatformComparison = false;
        }
    }

    private async Task HandlePdfImport(InputFileChangeEventArgs e)
    {
        isImporting = true;
        StateHasChanged();

        try
        {
            var file = e.File;
            if (file == null || !file.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
            {
                ToastService.ShowError("Please select a valid PDF file.");
                return;
            }

            // Read the PDF file
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var buffer = memoryStream.ToArray();

            // Parse the PDF
            var parser = new PdfReportParser();
            var importedConfig = parser.ParseMobileAppReport(buffer);

            // Ensure download sources are populated
            if (!importedConfig.IOSMetrics.DownloadSources.Any())
            {
                importedConfig.IOSMetrics.DownloadSources = new List<DownloadSource>
                {
                    new() { Name = "App Store Search" },
                    new() { Name = "Web Referrer" },
                    new() { Name = "App Referrer" },
                    new() { Name = "App Store Browse" },
                    new() { Name = "Unavailable" }
                };
            }

            // Store the imported config and show the dialog
            pendingImportConfig = importedConfig;
            showImportDialog = true;
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error importing PDF: {ex.Message}");
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }

    private void AddDownloadSource()
    {
        config.IOSMetrics.DownloadSources.Add(new DownloadSource());
    }

    private void RemoveDownloadSource(int index)
    {
        config.IOSMetrics.DownloadSources.RemoveAt(index);
    }

    private bool HasDownloadSourceMismatch()
    {
        var downloadSourcesTotal = GetDownloadSourcesTotal();
        var totalDownloads = config.IOSMetrics.TotalDownloads ?? 0;

        // Show warning if either value exists and they don't match
        if (downloadSourcesTotal > 0 || totalDownloads > 0)
        {
            return Math.Abs(downloadSourcesTotal - totalDownloads) > 0.01;
        }

        return false;
    }

    private double GetDownloadSourcesTotal()
    {
        return config.IOSMetrics.DownloadSources.Sum(s => s.CurrentDownloads ?? 0);
    }

    private void OnDownloadSourceChanged()
    {
        // Recalculate all download source percentages whenever values change
        config.IOSMetrics.CalculateDownloadSourcePercentages();
        StateHasChanged();
    }

    private void AddIOSVersionBreakdown()
    {
        config.IOSMetrics.DailyActiveUsersByVersionBreakdown.Add(new VersionDAU());
        StateHasChanged();
    }

    private void RemoveIOSVersionBreakdown(VersionDAU version)
    {
        config.IOSMetrics.DailyActiveUsersByVersionBreakdown.Remove(version);
        StateHasChanged();
    }

    private bool HasDailyActiveUsersMismatch()
    {
        // Only validate if user has added version breakdowns
        var hasVersionBreakdowns = config.IOSMetrics.DailyActiveUsersByVersionBreakdown
            .Any(v => !string.IsNullOrWhiteSpace(v.VersionNumber) || v.DailyActiveUsers.HasValue);
        
        if (!hasVersionBreakdowns)
        {
            return false;
        }

        var breakdownTotal = GetDailyActiveUsersBreakdownTotal();
        var totalDAU = config.IOSMetrics.DevicesActiveWithin30Days ?? 0;

        // Show warning if they don't match
        if (breakdownTotal > 0 || totalDAU > 0)
        {
            return Math.Abs(breakdownTotal - totalDAU) > 0.01;
        }

        return false;
    }

    private double GetDailyActiveUsersBreakdownTotal()
    {
        return config.IOSMetrics.DailyActiveUsersByVersionBreakdown
            .Where(v => !string.IsNullOrWhiteSpace(v.VersionNumber))
            .Sum(v => v.DailyActiveUsers ?? 0);
    }

    private async Task GenerateReport()
    {
        isGenerating = true;
        StateHasChanged();

        try
        {
            // ====== VALIDATION SECTION ======

            // 1. Always Required Fields (General Information)
            if (string.IsNullOrWhiteSpace(config.CreatedByName))
            {
                ToastService.ShowError("Please provide Created By Name");
                isGenerating = false;
                StateHasChanged();
                return;
            }

            if (!config.ReportMonth.HasValue || config.ReportMonth.Value < 1 || config.ReportMonth.Value > 12)
            {
                ToastService.ShowError("Please provide a valid Report Month (1-12)");
                isGenerating = false;
                StateHasChanged();
                return;
            }

            if (!config.ReportDay.HasValue || config.ReportDay.Value < 1 || config.ReportDay.Value > 31)
            {
                ToastService.ShowError("Please provide a valid Report Day (1-31)");
                isGenerating = false;
                StateHasChanged();
                return;
            }

            if (!config.ReportYear.HasValue || config.ReportYear.Value < 2000)
            {
                ToastService.ShowError("Please provide a valid Report Year (must be 2000 or later)");
                isGenerating = false;
                StateHasChanged();
                return;
            }

            // 2. Conditional Required Fields - Executive Summary
            if (config.IncludeExecutiveSummary && string.IsNullOrWhiteSpace(config.ExecutiveSummary))
            {
                ToastService.ShowError("Executive Summary is selected but the summary text is empty. Please provide a summary or uncheck the section.");
                isGenerating = false;
                StateHasChanged();
                return;
            }

            // 3. Conditional Required Fields - iOS Section
            if (config.IncludeIOSSection)
            {
                if (!config.IOSMetrics.TotalDownloads.HasValue ||
                    !config.IOSMetrics.DailyDownloads.HasValue ||
                    !config.IOSMetrics.TotalCrashes.HasValue ||
                    !config.IOSMetrics.TotalCrashes.HasValue ||
                    !config.IOSMetrics.DevicesActiveWithin30Days.HasValue ||
                    !config.IOSMetrics.LifetimeDeletions.HasValue ||
                    !config.IOSMetrics.LifetimeReDownloads.HasValue)
                {
                    ToastService.ShowError("iOS section is selected but some required fields are missing. Please fill in all iOS metrics or uncheck the section.");
                    isGenerating = false;
                    StateHasChanged();
                    return;
                }

                // Validate download sources have names
                if (config.IOSMetrics.DownloadSources.Any(s => string.IsNullOrWhiteSpace(s.Name)))
                {
                    ToastService.ShowError("iOS section: All download sources must have a name. Please provide names or remove empty sources.");
                    isGenerating = false;
                    StateHasChanged();
                    return;
                }
            }

            // 4. Conditional Required Fields - Android Section
            if (config.IncludeAndroidSection)
            {
                if (!config.AndroidMetrics.TotalDownloads.HasValue ||
                    !config.AndroidMetrics.DailyDownloads.HasValue ||
                    !config.AndroidMetrics.TotalCrashes.HasValue)
                {
                    ToastService.ShowError("Android section is selected but all required fields must be filled. Please fill in all Android metrics or uncheck the section.");
                    isGenerating = false;
                    StateHasChanged();
                    return;
                }
            }



            // 6. Platform Comparison Logic Check
            if (config.IncludePlatformComparison && (!config.IncludeIOSSection || !config.IncludeAndroidSection))
            {
                ToastService.ShowError("Platform Comparison requires both iOS and Android sections to be selected.");
                isGenerating = false;
                StateHasChanged();
                return;
            }

            // 7. Existing validation: iOS download sources vs total downloads
            var downloadSourcesTotal = config.IOSMetrics.DownloadSources.Sum(s => s.CurrentDownloads ?? 0);
            var totalDownloads = config.IOSMetrics.TotalDownloads ?? 0;

            if (downloadSourcesTotal > 0 && totalDownloads > 0 && Math.Abs(downloadSourcesTotal - totalDownloads) > 0.01)
            {
                ToastService.ShowError($"iOS Download Sources total ({downloadSourcesTotal:N0}) does not match Total Downloads ({totalDownloads:N0}). Please correct the values before generating the report.");
                isGenerating = false;
                StateHasChanged();
                return;
            }

            // ====== END VALIDATION SECTION ======

            // Auto-calculate download source percentages before generating
            config.IOSMetrics.CalculateDownloadSourcePercentages();

            // Auto-populate platform comparison from iOS and Android data
            config.SyncPlatformComparison();

            var generator = new MobileAppReportGenerator();
            var pdfBytes = generator.GeneratePdf(config);

            // Download the PDF
            var fileName = $"{config.CompanyName}_Mobile_App_Report_{config.ReportMonth}_{config.ReportDay}_{config.ReportYear}.pdf";
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(pdfBytes));

            ToastService.ShowSuccess("PDF report generated successfully!");

            // Auto-open metrics pages if app identifiers are provided
            await OpenMetricsPages();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error generating report: {ex.Message}");
            Console.WriteLine($"Error generating report: {ex.Message}\n{ex.StackTrace}");
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private void ImportToCurrentPeriod()
    {
        if (pendingImportConfig != null)
        {
            config = pendingImportConfig;
            ToastService.ShowSuccess("Successfully imported data to current period fields!");
        }

        showImportDialog = false;
        pendingImportConfig = null;
        StateHasChanged();
    }

    private void ImportToPreviousPeriod()
    {
        if (pendingImportConfig != null)
        {
            // Map current period values from imported config to last period fields in current config

            // Import company name if current is empty, otherwise keep current
            if (string.IsNullOrWhiteSpace(config.CompanyName))
            {
                config.CompanyName = pendingImportConfig.CompanyName;
            }

            // Import creator info from the imported report (they created the last report)
            config.CreatedByName = pendingImportConfig.CreatedByName;
            config.CreatedByTitle = pendingImportConfig.CreatedByTitle;

            // General info - keep current config's current period, import to last period
            config.LastReportMonth = pendingImportConfig.ReportMonth;
            config.LastReportDay = pendingImportConfig.ReportDay;
            config.LastReportYear = pendingImportConfig.ReportYear;

            // iOS Metrics - map current to last (handle old PDF format gracefully)
            config.IOSMetrics.TotalDownloadsLast = pendingImportConfig.IOSMetrics.TotalDownloads;
            config.IOSMetrics.DailyDownloadsLast = pendingImportConfig.IOSMetrics.DailyDownloads;
            config.IOSMetrics.TotalCrashesLast = pendingImportConfig.IOSMetrics.TotalCrashes;
            config.IOSMetrics.TotalCrashesLast = pendingImportConfig.IOSMetrics.TotalCrashes;
            config.IOSMetrics.DevicesActiveWithin30DaysLast = pendingImportConfig.IOSMetrics.DevicesActiveWithin30Days;
            config.IOSMetrics.LifetimeDeletionsLast = pendingImportConfig.IOSMetrics.LifetimeDeletions;
            config.IOSMetrics.LifetimeReDownloadsLast = pendingImportConfig.IOSMetrics.LifetimeReDownloads;

            // Download sources - map current to last
            for (int i = 0; i < Math.Min(config.IOSMetrics.DownloadSources.Count, pendingImportConfig.IOSMetrics.DownloadSources.Count); i++)
            {
                config.IOSMetrics.DownloadSources[i].LastDownloads = pendingImportConfig.IOSMetrics.DownloadSources[i].CurrentDownloads;
                config.IOSMetrics.DownloadSources[i].LastPercentage = pendingImportConfig.IOSMetrics.DownloadSources[i].CurrentPercentage;
            }

            // Android Metrics - map current to last
            config.AndroidMetrics.TotalDownloadsLast = pendingImportConfig.AndroidMetrics.TotalDownloads;
            config.AndroidMetrics.DailyDownloadsLast = pendingImportConfig.AndroidMetrics.DailyDownloads;
            config.AndroidMetrics.TotalCrashesLast = pendingImportConfig.AndroidMetrics.TotalCrashes;

            // Platform Comparison - map current to last
            config.PlatformComparison.IOSTotalDownloadsLast = pendingImportConfig.PlatformComparison.IOSTotalDownloads;
            config.PlatformComparison.AndroidTotalDownloadsLast = pendingImportConfig.PlatformComparison.AndroidTotalDownloads;
            config.PlatformComparison.IOSUserPercentLast = pendingImportConfig.PlatformComparison.IOSUserPercent;
            config.PlatformComparison.AndroidUserPercentLast = pendingImportConfig.PlatformComparison.AndroidUserPercent;
            config.PlatformComparison.IOSDailyDownloadsLast = pendingImportConfig.PlatformComparison.IOSDailyDownloads;
            config.PlatformComparison.AndroidDailyDownloadsLast = pendingImportConfig.PlatformComparison.AndroidDailyDownloads;
            config.PlatformComparison.IOSTotalCrashesLast = pendingImportConfig.PlatformComparison.IOSTotalCrashes;
            config.PlatformComparison.AndroidTotalCrashesLast = pendingImportConfig.PlatformComparison.AndroidTotalCrashes;

            // Enable last period data if not already enabled
            config.IncludeLastPeriodData = true;

            ToastService.ShowSuccess("Successfully imported data to previous period fields!");
        }

        showImportDialog = false;
        pendingImportConfig = null;
        StateHasChanged();
    }

    private void CancelImport()
    {
        showImportDialog = false;
        pendingImportConfig = null;
        ToastService.ShowInfo("Import cancelled.");
        StateHasChanged();
    }

    private string FormatChange(double? value)
    {
        if (!value.HasValue)
            return "-";

        var sign = value.Value >= 0 ? "+" : "";
        return $"{sign}{value.Value:N2}%";
    }

    private async Task OpenMetricsPages()
    {
        try
        {
            var opened = false;

            // Open iOS App Analytics if identifier is provided
            if (!string.IsNullOrWhiteSpace(iosAppIdentifier))
            {
                var iosUrl = $"https://appstoreconnect.apple.com/analytics/app/{iosAppIdentifier}/metrics";
                await JSRuntime.InvokeVoidAsync("open", iosUrl, "_blank");
                opened = true;
            }

            // Open Google Play Console if identifier is provided
            if (!string.IsNullOrWhiteSpace(androidAppIdentifier))
            {
                var androidUrl = $"https://play.google.com/console/u/0/developers/{androidAppIdentifier}/app-dashboard";
                await JSRuntime.InvokeVoidAsync("open", androidUrl, "_blank");
                opened = true;
            }

            if (opened)
            {
                ToastService.ShowInfo("Opening metrics pages in new tabs...");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error opening metrics pages: {ex.Message}");
        }
    }
}
